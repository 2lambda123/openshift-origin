apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: openshift-apiserver-operator
parameters:
- name: IMAGE
  value: openshift/origin:latest
- name: NAMESPACE
  value: openshift-core-operators
- name: LOGLEVEL
  value: "0"
- name: OPENSHIFT_APISERVER_CONFIG_HOST_PATH
objects:

- apiVersion: apiextensions.k8s.io/v1beta1
  kind: CustomResourceDefinition
  metadata:
    name: openshiftapiserverconfigs.operator.openshift.io
  spec:
    scope: Cluster
    group: operator.openshift.io
    version: v1
    names:
      kind: OpenShiftAPIServerConfig
      plural: openshiftapiserverconfigs
      singular: openshiftapiserverconfig

- apiVersion: v1
  kind: Namespace
  metadata:
    name: ${NAMESPACE}
    labels:
      "openshift.io/run-level": "1"

- apiVersion: v1
  kind: ServiceAccount
  metadata:
    namespace: ${NAMESPACE}
    name: apiserver-operator

# TODO make a real, constrained clusterole and bind that instead
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    namespace: ${NAMESPACE}
    name: apiserver-operator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: cluster-admin
  subjects:
  - kind: ServiceAccount
    name: apiserver-operator
    namespace: ${NAMESPACE}

- apiVersion: apps/v1
  kind: Deployment
  metadata:
    namespace: ${NAMESPACE}
    name: apiserver-operator
    labels:
      openshift.io/operator: "true"
      openshift.io/component: api
  spec:
    replicas: 1
    selector:
      matchLabels:
        openshift.io/operator: "true"
        openshift.io/component: api
    template:
      metadata:
        name: apiserver-operator
        labels:
          openshift.io/operator: "true"
          openshift.io/component: api
      spec:
        serviceAccountName: apiserver-operator
        restartPolicy: Always
        containers:
        - name: apiserver-operator
          image: ${IMAGE}
          imagePullPolicy: IfNotPresent
          command: ["hypershift", "experimental", "openshift-apiserver-operator"]
          args:
          - "-v=5"

- apiVersion: operator.openshift.io/v1
  kind: OpenShiftAPIServerConfig
  metadata:
    name: instance
  spec:
    imagePullSpec: ${IMAGE}
    version: 3.10.0
    apiServerConfig:
      logLevel: ${{LOGLEVEL}}
      port: 8445
      hostPath: ${OPENSHIFT_APISERVER_CONFIG_HOST_PATH}