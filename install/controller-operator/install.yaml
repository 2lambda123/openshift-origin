apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: openshift-controller-manager-operator
parameters:
- name: IMAGE
  value: openshift/origin:latest
- name: NAMESPACE
  value: openshift-core-operators
- name: LOGLEVEL
  value: "0"
- name: OPENSHIFT_CONTROLLER_MANAGER_CONFIG_HOST_PATH
objects:

- apiVersion: apiextensions.k8s.io/v1beta1
  kind: CustomResourceDefinition
  metadata:
    name: openshiftcontrollerconfigs.operator.openshift.io
  spec:
    scope: Cluster
    group: operator.openshift.io
    version: v1
    names:
      kind: OpenShiftControllerConfig
      plural: openshiftcontrollerconfigs
      singular: openshiftcontrollerconfig

- apiVersion: v1
  kind: Namespace
  metadata:
    name: ${NAMESPACE}
    labels:
      "openshift.io/run-level": "1"

- apiVersion: v1
  kind: ServiceAccount
  metadata:
    namespace: ${NAMESPACE}
    name: controller-manager-operator

# TODO make a real, constrained clusterole and bind that instead
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    namespace: ${NAMESPACE}
    name: controller-manager-operator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: cluster-admin
  subjects:
  - kind: ServiceAccount
    name: controller-manager-operator
    namespace: ${NAMESPACE}

- apiVersion: apps/v1
  kind: Deployment
  metadata:
    namespace: ${NAMESPACE}
    name: controller-manager-operator
    labels:
      openshift.io/operator: "true"
      openshift.io/component: controller
  spec:
    replicas: 1
    selector:
      matchLabels:
        openshift.io/operator: "true"
        openshift.io/component: controller
    template:
      metadata:
        name: controller-manager-operator
        labels:
          openshift.io/operator: "true"
          openshift.io/component: controller
      spec:
        serviceAccountName: controller-manager-operator
        restartPolicy: Always
        containers:
        - name: controller-manager-operator
          image: ${IMAGE}
          imagePullPolicy: IfNotPresent
          command: ["hypershift", "experimental", "openshift-controller-operator"]
          args:
          - "-v=5"

- apiVersion: operator.openshift.io/v1
  kind: OpenShiftControllerConfig
  metadata:
    name: instance
  spec:
    imagePullSpec: ${IMAGE}
    version: 3.10.0
    apiServerConfig:
      logLevel: ${{LOGLEVEL}}
      port: 8444
      hostPath: ${OPENSHIFT_CONTROLLER_MANAGER_CONFIG_HOST_PATH}