DEMO HA Routing Failover
------------------------

1. Start the sample app (this is simulating the openshift router for now).

    vagrant ssh minion-1  #  vagrant ssh minion-2

    #  And run this setup on each of the minions.
    sudo docker rm -f $(sudo docker ps -q -s)
    sudo docker run -dit -p 8080:8080 openshift/hello-openshift

    #  Ensure you can get to the hello openshift app from outside the vm.
    curl -k http://10.245.2.3:8080/
    curl -k http://10.245.2.4:8080/


2. Copy the router HA settings example config and edit it as needed.

    cd /vagrant/hack/exp
    cp router-HA.settings.example  router-HA.settings.minion-1
    cp router-HA.settings.example  router-HA.settings.minion-2

    #  And as per your environment, set/edit the values for 
    #    ADMIN_EMAILS, EMAIL_FROM, SMTP_SERVER,
    #    PRIMARY_HA_VIPS, SLAVE_HA_VIPS and INTERFACE.

    #  Demo: flip PRIMARY and SLAVE groups on minion-2
    sed -i "s/^PRIMARY_GROUPS=\(.*\)/PRIMARY_GROUPS_OLD=\1/g;
            s/^SLAVE_GROUPS=\(.*\)/PRIMARY_GROUPS=\1/g;
            s/^PRIMARY_GROUPS_OLD=\(.*\)/SLAVE_GROUPS=\1/g;" \
	router-HA.settings.minion-2


3. Setup the HA setup using the 2 config files we created 

    # Run these commands on the minions via vagrant ssh minion-{1,2}
    cd /vagrant/hack/exp
    sudo ./setup-router-HA.sh router-HA.settings.minion-1  # *.minion-2


4. Check that you can get to the hello openshift app using the VIPs from
   inside/outside the vms.

    curl -k http://10.245.2.111:8080/
    curl -k http://10.245.2.222:8080/
    curl -k http://10.245.2.223:8080/
    curl -k http://10.245.2.90:8080/

5. On each minion, see what VIPs are being serviced by that minion.

    ip a s enp0s8   #  repeat on minion-1 and minion-2

6. Halt one of the minions ... 

    vagrant ssh halt minion-1

7. Check that you can still get to the hello openshift app using the VIPs from
   inside/outside the vms.

    curl -k http://10.245.2.111:8080/
    curl -k http://10.245.2.222:8080/
    curl -k http://10.245.2.223:8080/
    curl -k http://10.245.2.90:8080/


CASES still to be handled
-------------------------
TODO: stop keepalived if the router/docker container goes down.
      And start it if it comes back up. That's one way to ensure HA.

