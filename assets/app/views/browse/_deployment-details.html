<div class="row" style="max-width: 650px;">
  <div class="col-sm-4 col-sm-push-8 text-center">
    <pod-status-chart
        pods="podsForDeployment"
        ng-if="podsForDeployment"
        desired="deployment.spec.replicas"
        ng-click="viewPodsForDeployment()"
        ng-class="{ clickable: (podsForDeployment | hashSize) > 0 }"
        style="display: inline-block;">
    </pod-status-chart>
    <!-- Add a link for screen readers. -->
    <a href=""
       class="sr-only"
       ng-click="viewPodsForDeployment()"
       ng-if="(podsForDeployment | hashSize) > 0"
       role="button">
       View pods for deployment.metadata.name
    </a>
  </div>
  <div class="col-sm-8 col-sm-pull-4">
    <dl class="dl-horizontal left">
      <dt ng-if-start="deployment | isDeployment">Status:</dt>
      <dd ng-if-end>
        <status-icon status="deployment | deploymentStatus"></status-icon>
        {{deployment | deploymentStatus}}
        <span style="margin-left: 7px;">
          <button ng-show="!rollBackCollapsed && (deployment | deploymentStatus) == 'Complete' && !(deployment | deploymentIsLatest : deploymentConfig) && !deployment.metadata.deletionTimestamp" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0" type="button" class="btn btn-default btn-xs" ng-click="rollBackCollapsed = !rollBackCollapsed">Roll Back</button>
          <div ng-show="rollBackCollapsed" class="well well-sm">
            Use the following settings from {{deployment.metadata.name}} when rolling back:
            <div class="checkbox">
              <label>
                <input type="checkbox" ng-model="changeScaleSettings" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0"> replica count and selector
              </label>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox" ng-model="changeStrategy" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0"> deployment strategy
              </label>
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox" ng-model="changeTriggers" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0"> deployment trigger
              </label>
            </div>
            <button type="button" ng-click="rollbackToDeployment(deployment, changeScaleSettings, changeStrategy, changeTriggers)" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0" class="btn btn-default btn-xs">Roll Back</button>
          </div>
          <!-- disabled until we have an api endpoint for retry
          <button ng-show="(deployment | deploymentStatus) == 'Failed'" type="button" ng-click="retryFailedDeployment(deployment)" ng-disabled="(deploymentConfigDeploymentsInProgress[deploymentConfigName] | hashSize) > 0" class="btn btn-default btn-xs" ng-if="(deployment | deploymentIsLatest : deploymentConfig) && !deployment.metadata.deletionTimestamp">Retry</button>
          -->
          <button ng-show="(deployment | deploymentIsInProgress) && !deployment.metadata.deletionTimestamp" type="button" ng-click="cancelRunningDeployment(deployment)" class="btn btn-default btn-xs">Cancel</button>
        </span>
      </dd>
      <dt ng-if-start="deployment | isDeployment">Deployment config:</dt>
      <dd ng-if-end>
        <a ng-href="{{deploymentConfigName | navigateResourceURL : 'DeploymentConfig' : deployment.metadata.namespace}}">{{deploymentConfigName}}</a>
      </dd>
      <dt ng-if-start="deployment | annotation:'deploymentStatusReason'">Status reason:</dt>
      <dd ng-if-end>
        {{deployment | annotation:'deploymentStatusReason'}}
      </dd>
      <dt ng-if-start="deployment | deploymentIsInProgress">Duration:</dt>
      <dd ng-if-end>
        <span ng-switch="deployment | deploymentStatus" class="hide-ng-leave">
          <span ng-switch-when="Running">running for <duration-until-now timestamp="deployment.metadata.creationTimestamp"></duration-until-now></span>
          <span ng-switch-default>waiting for <duration-until-now timestamp="deployment.metadata.creationTimestamp"></duration-until-now></span>
        </span>
      </dd>
      <dt>Selectors:</dt>
      <dd>
        <span ng-if="!deployment.spec.selector">none</span>
        <span ng-repeat="(labelKey, labelValue) in deployment.spec.selector" class="word-break">{{labelKey}}={{labelValue}}<span ng-show="!$last">, </span></span>
      </dd>
      <dt>Replicas:</dt>
      <dd>
        <!-- Enable scaling if this is a plain replication controller or it's the active deployment. -->
        <replicas status="deployment.status.replicas"
                  spec="deployment.spec.replicas"
                  disable-scaling="(deployment | isDeployment) && !deploymentConfigMissing && (!isActive || !deploymentConfig)"
                  scale-fn="scale(replicas)">
        </replicas>
      </dd>
    </dl>
  </div>
</div>
<annotations annotations="deployment.metadata.annotations"></annotations>
<div class="deployment-detail">
  <span>Pod template:</span>
  <pod-template
    pod-template="deployment.spec.template"
    images-by-docker-reference="imagesByDockerReference"
    builds="builds"
    detailed="true"></pod-template>
  <h4 style="margin-top: 20px;">Volumes</h4>
  <p ng-if="!deployment.spec.template.spec.volumes.length">
    <a ng-href="project/{{project.metadata.name}}/attach-pvc?deployment={{deployment.metadata.name}}">Attach storage</a>
  </p>
  <volumes volumes="deployment.spec.template.spec.volumes" namespace="project.metadata.name"></volumes>
</div>

<!-- Autoscaling -->
<div ng-if="!deploymentConfigName || (autoscalers | hashSize) > 0">
  <h3>Autoscaling</h3>

  <!-- Warning: metrics not configured -->
  <div ng-if="metricsWarning && (autoscalers | hashSize) > 0" class="alert alert-warning">
    <span class="pficon pficon-warning-triangle-o" aria-hidden="true"></span>
    <span class="sr-only">Warning:</span>
    Metrics might not be configured by your cluster administrator. Metrics are required for autoscaling.
  </div>

  <!-- Warning: CPU request not set -->
  <div ng-if="!hasCPURequest && (autoscalers | hashSize) > 0" class="alert alert-warning">
    <span class="pficon pficon-warning-triangle-o" aria-hidden="true"></span>
    <span class="sr-only">Warning:</span>
    This
    <span ng-if="deployment | isDeployment">deployment</span>
    <span ng-if="!(deployment | isDeployment)">replication controller</span>
    does not have any containers with a CPU
    <span ng-if="'cpu' | isRequestCalculated : project">limit</span>
    <span ng-if="!('cpu' | isRequestCalculated : project)">request</span>
    set. Autoscaling will not work without a CPU
    <span ng-if="'cpu' | isRequestCalculated : project">limit.</span>
    <span ng-if="!('cpu' | isRequestCalculated : project)">request.</span>
    <span ng-if="'cpu' | isLimitCalculated : project">
      The CPU limit will be automatically calculated from the container memory limit.
    </span>
    <!-- Prompt to set resource request only for replication controllers with no deployment config. -->
    <a ng-href="project/{{projectName}}/set-limits?rcName={{deployment.metadata.name}}"
       ng-if="!(deployment | isDeployment)"
       role="button">Set resource
        <span ng-if="!('cpu' | isRequestCalculated : project)">requests and</span> limits</a>
  </div>

  <!-- Warning: multiple autoscalers -->
  <div ng-if="(autoscalers | hashSize) > 1" class="alert alert-warning">
    <span class="pficon pficon-warning-triangle-o" aria-hidden="true"></span>
    <span class="sr-only">Warning:</span>
    More than one autoscaler is scaling this resource.  This is not recommended because they might
    compete with each other. Consider removing all but one autoscaler.
  </div>

  <!-- Create autoscaler -->
  <div ng-if="(autoscalers | hashSize) === 0">
    <a ng-href="project/{{projectName}}/edit/autoscaler?kind=ReplicationController&name={{deployment.metadata.name}}"
       role="button">Add autoscaler</a>
  </div>

  <!-- HPA details -->
  <div ng-repeat="hpa in autoscalers">
    <h3 ng-if="(autoscalers | hashSize) > 1">{{hpa.metadata.name}}</h3>

    <!-- Warning: scaled by RC and DC -->
    <div ng-if="(deployment | isDeployment) && hpa.spec.scaleRef.kind === 'ReplicationController'" class="alert alert-warning">
      <span class="pficon pficon-warning-triangle-o" aria-hidden="true"></span>
      <span class="sr-only">Warning:</span>
      This deployment is scaled by both deployment config
      <a ng-href="{{deploymentConfigName | navigateResourceURL : 'DeploymentConfig' : deployment.metadata.namespace}}">{{deploymentConfigName}}</a>
      and an autoscaler. This is not recommended because they might compete with each other.
      <delete-link
          kind="HorizontalPodAutoscaler"
          group="extensions"
          resource-name="{{hpa.metadata.name}}"
          project-name="{{hpa.metadata.namespace}}"
          label="Remove autoscaler {{hpa.metadata.name}}?"
          alerts="alerts"
          stay-on-current-page="true">
      </delete-link>
    </div>

    <hpa hpa="hpa"
         show-scale-target="hpa.spec.scaleRef.kind !== 'ReplicationController'"
         alerts="alerts">
    </hpa>
  </div>
</div>
