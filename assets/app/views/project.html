<project-header class="top-header"></project-header>
<project-page class="project-overview-page">

  <!-- Middle section -->
  <div class="middle-section">
    <div class="middle-container">
      <div class="middle-header header-light">
        <div class="container-fluid">
          <tasks></tasks>

          <div ng-if="renderOptions.showToolbar" class="page-header page-header-bleed-right page-header-bleed-left">
            <h1 title="Overview">Overview</h1>
          </div>
          <!-- TODO handle things that don't live under services -->
          <alerts alerts="alerts"></alerts>
          <div ng-if="renderOptions.showToolbar" class="data-toolbar">
            <div class="data-toolbar-filter">
              <project-filter></project-filter>
            </div>
            <div class="data-toolbar-views" style="flex:0 0 95px;">
              <div class="actions">
                <div class="btn-group">
                  <label class="btn btn-default" ng-model="$parent.overviewMode" uib-btn-radio="'tiles'" title="Tile View">
                    <i class="fa fa-list"></i>
                  </label>
                  <label class="btn btn-default" ng-model="$parent.overviewMode" uib-btn-radio="'pipelines'" title="Pipelines View">
                    <i class="pficon pficon-topology"></i>
                  </label>
                  <label class="btn btn-default" ng-model="$parent.overviewMode" uib-btn-radio="'topology'" title="Topology View">
                    <i class="pficon pficon-topology"></i>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /middle-header-->
      <div class="middle-content  has-scroll surface-shaded">
        <div class="container-fluid surface-shaded">
          <div class="row">
            <div class="col-md-12 gutter-top">

              <!-- Empty states -->
              <div ng-if="(services | hashSize) === 0 && (monopodsByService[''] | hashSize) === 0 && (deploymentsByServiceByDeploymentConfig[''] | hashSize) === 0">
                <!-- Getting started -->
                <div ng-if="renderOptions.showGetStarted" class="empty-project text-center">
                  <h2>Get started with your project.</h2>
                  <p class="gutter-top">
                    Use your source or an example repository to build an application
                    image, or add components like databases and message queues.
                  </p>
                  <p class="gutter-top">
                    <a ng-href="project/{{projectName}}/create" class="btn btn-lg btn-primary">
                      Add to Project
                    </a>
                  </p>
                </div>
                <!-- Normal empty message (loading... or filtered) -->
                <div ng-if="!renderOptions.showGetStarted">
                  <em>{{emptyMessage}}</em>
                </div>
              </div>

              <div ng-if="overviewMode == 'topology' && !renderOptions.showGetStarted">
                <kubernetes-topology-graph bottom-of-window="1" items="topologyItems"
                  relations="topologyRelations" kinds="topologyKinds" selection="topologySelection">
                </kubernetes-topology-graph>
                <svg class="kube-topology" hidden>
                  <defs>
                    <g class="Pod" id="vertex-Pod">
                      <circle r="16"></circle>
                      <text y="6" x="0.5">&#xf1b3;</text>
                    </g>
                    <g class="Service" id="vertex-Service">
                      <circle r="16"></circle>
                      <text y="10" x="1">&#xe61e;</text>
                    </g>
                    <g class="ReplicationController" id="vertex-ReplicationController">
                      <circle r="16"></circle>
                      <text y="9">&#xe624;</text>
                    </g>
                    <g class="DeploymentConfig" id="vertex-DeploymentConfig">
                      <circle r="16"></circle>
                      <text y="8">&#xf013;</text>
                    </g>
                    <g class="Route" id="vertex-Route">
                      <circle r="16"></circle>
                      <text y="9">&#xe625;</text>
                    </g>
                  </defs>
                </svg>
              </div>

              <div ng-if="overviewMode == 'tiles'">
                <!-- TODO handle multiple services mapping to the same deploymentConfig/deployment/pod -->
                <section ng-repeat="(serviceId, service) in services" class="components components-group" ng-attr-id="service-{{serviceId}}">
                  <div class="osc-object components-panel service" ng-init="numPorts = service.spec.ports.length" kind="Service" resource="service">
                    <div class="component-block">
                      <div class="component">
                        <div ng-attr-title="{{service | serviceImplicitDNSName}}" class="component-label">
                          <!-- "service" class is present for e2e tests to check   -->
                          Service <span ng-if="displayRouteByService[serviceId]">: <a class="subtle-link service" href="{{service | navigateResourceURL}}">{{serviceId}}</a></span>
                        </div>

                        <!-- Show the route if present -->
                        <h2 ng-if="displayRouteByService[serviceId]" ng-init="otherRoutes = (routesByService[serviceId] | hashSize) - 1">
                          <span ng-if="(displayRouteByService[serviceId] | isWebRoute)">
                            <!-- "route" class is present for e2e tests to check -->
                            <a href="{{displayRouteByService[serviceId] | routeWebURL}}" class="route" target="_blank">{{displayRouteByService[serviceId] | routeLabel}}</a>
                          </span>
                          <!-- "route" class is present for e2e test -->
                          <span ng-if="!(displayRouteByService[serviceId] | isWebRoute)" class="route">
                            {{displayRouteByService[serviceId] | routeLabel}}
                          </span>
                          <span class="small" ng-if="otherRoutes">
                            (and
                            <a href="{{service | navigateResourceURL}}">{{otherRoutes}} other {{(otherRoutes == 1) ? 'route' : 'routes'}}</a>)
                          </span>
                          <span ng-if="!otherRoutes">
                            <route-warnings warnings="routeWarningsByService[serviceId][displayRouteByService[serviceId].metadata.name]"></route-warnings>
                          </span>
                          <div ng-if="(routeWarningsByService[serviceId] | hashSize) > 0 && otherRoutes">
                            <small>
                              <span class="pficon pficon-warning-triangle-o" aria-hidden="true"></span>
                              This service has <a href="project/{{projectName}}/browse/routes">routes</a> with warnings.
                            </small>
                          </div>                          
                        </h2>

                        <!-- If no route is present, show the service name large -->
                        <!-- "service" class is present for e2e tests to check   -->
                        <h2 ng-if="!displayRouteByService[serviceId]">
                          <a class="service" href="{{service | navigateResourceURL}}">{{serviceId}}</a>
                        </h2>
                      </div>

                      <div class="component meta-data">
                        <span ng-if="numPorts" class="ports">
                          <!--
                          Show only the first two ports if there are many since we don't have much space here.
                          The full list is visible elsewhere.
                          -->
                          <span ng-repeat="portMapping in service.spec.ports | orderBy:'port' | limitTo:2">
                            <!-- Group port mappings and allow multiple mappings to stack if needed -->
                            <span class="port-mappings">
                              <!-- TODO: Include the port name directly in the content.
                                         There's just not enough room now, and we already have problems with wrapping. -->
                              <span ng-attr-title="{{portMapping.name}}">{{portMapping.port}}/{{portMapping.protocol}}</span>&#8201;&#8594;&#8201;{{portMapping.targetPort}}<span ng-if="$index < (numPorts - 1)">, </span></span>
                          </span>
                          <span ng-if="numPorts > 2" ng-init="numRemaining = numPorts - 2" class="more-ports">
                            and {{numRemaining}} {{numRemaining == 1 ? "other" : "others"}}
                          </span>
                        </span>
                        <div ng-if="!displayRouteByService[serviceId]" class="component-label add-route-link">
                          <a ng-href="project/{{project.metadata.name}}/create-route?service={{service.metadata.name}}">Create Route</a>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!--
                  Iterate over deploymentConfigs for this service.
                  Find ones that don't have any deployments for this service.
                  These are likely new, and could have incoming builds, which we want to surface.
                   -->
                  <div ng-repeat="(deploymentConfigId, deploymentConfig) in deploymentConfigsByService[serviceId]"
                       ng-if="!deploymentsByServiceByDeploymentConfig[serviceId][deploymentConfigId]">
                    <!--
                    Pods in deployments created from this deployment config will be routed to by this service.
                    Show things related to triggers that are about to create stuff, like builds.
                    -->
                    <triggers triggers="deploymentConfig.spec.triggers" builds-by-output-image="recentBuildsByOutputImage" namespace="projectName"></triggers>
                  </div>
                  <!--
                  Iterate over all deployments for this service grouped by deploymentConfig (or lack thereof)
                  -->
                  <div ng-repeat="(deploymentConfigId, deployments) in deploymentsByServiceByDeploymentConfig[serviceId]">
                    <!--
                    deploymentConfig could be null:
                    1. when we have replicationControllers that were not generated from a deploymentConfig (deploymentConfigId=='')
                    2. when the deploymentConfig for these deployments no longer exists
                    3. when the deploymentConfig for these deployments no longer falls under this service
                    -->
                    <div ng-if="deploymentConfigsByService[serviceId][deploymentConfigId]">
                      <!--
                      Pods in deployments created from this deployment config will be routed to by this service.
                      Show things related to triggers that are about to create stuff, like builds.
                      -->
                      <triggers triggers="deploymentConfigsByService[serviceId][deploymentConfigId].spec.triggers" builds-by-output-image="recentBuildsByOutputImage" namespace="projectName"></triggers>
                    </div>

                    <div ng-repeat="deployment in deployments | orderObjectsByDate : true track by (deployment | uid)"
                         ng-if="isVisibleDeployment(deployment)"
                         class="animate-repeat">

                      <!-- Make sure deploymentConfigs are loaded before testing if the deployment config is missing. -->
                      <overview-deployment
                        rc="deployment"
                        deployment-config-id="deploymentConfigId"
                        deployment-config-missing="deploymentConfigs && !deploymentConfigs[deploymentConfigId]"
                        deployment-config-different-service="deploymentConfigs[deploymentConfigId] && !deploymentConfigsByService[serviceId][deploymentConfigId]"
                        deployment-config="deploymentConfigs[deploymentConfigId]"
                        scalable="isScalable(deployment, deploymentConfigId)"
                        images-by-docker-reference="imagesByDockerReference"
                        builds="builds"
                        pods="podsByDeployment[deployment.metadata.name]"
                        alerts="alerts">
                      </overview-deployment>
                    </div>
                  </div>

                  <!-- Now go through any of the pods that are routed to by the service but not part of a deployment -->
                  <div ng-repeat="pod in monopodsByService[serviceId] track by (pod | uid)">
                    <overview-monopod pod="pod"></overview-monopod>
                  </div>

                  <!-- TODO implement filters for empty and present to return booleans for cases like this -->
                  <div ng-if="(podsByService[serviceId] | hashSize) === 0 && (deploymentsByServiceByDeploymentConfig[serviceId] | hashSize) === 0"
                       class="osc-object components-panel deployment-block deployments none">
                    <span class="pficon pficon-info"></span> There are no pods or deployments for this service.
                  </div>
                </section>

                <!-- Show deploymentsConfigs not in a service -->
                <section ng-repeat="(deploymentConfigId, deployments) in deploymentsByServiceByDeploymentConfig['']" class="components">
                  <div ng-repeat="(deploymentId, deployment) in deploymentsByServiceByDeploymentConfig[''][deploymentConfigId] track by (deployment | uid)"
                       ng-if="isVisibleDeployment(deployment)">
                    <div class="builds-no-service" ng-if="deploymentConfigs[deploymentConfigId] && deploymentConfigsByService[''][deploymentConfigId]">
                      <!--
                      Pods in deployments created from this deployment config will not be routed to by any service.
                      Show things related to triggers that are about to create stuff, like builds.
                      -->
                      <triggers triggers="deploymentConfigs[deploymentConfigId].spec.triggers" builds-by-output-image="recentBuildsByOutputImage" namespace="projectName"></triggers>
                    </div>
                    <!-- Make sure deploymentConfigs are loaded before testing if the deployment config is missing. -->
                    <overview-deployment
                      rc="deployment"
                      deployment-config-id="deploymentConfigId"
                      deployment-config-missing="deploymentConfigs && !deploymentConfigs[deploymentConfigId]"
                      deployment-config-different-service="deploymentConfigs[deploymentConfigId] && !deploymentConfigsByService[''][deploymentConfigId]"
                      scalable="true"
                      images-by-docker-reference="imagesByDockerReference"
                      builds="builds"
                      pods="podsByDeployment[deployment.metadata.name]">
                    </overview-deployment>
                  </div>
                </section>

                <section ng-repeat="pod in monopodsByService[''] track by (pod | uid)" class="components">
                  <overview-monopod pod="pod"></overview-monopod>
                </section>
              </div>


              <!-- PIPELINES -->
              <!-- PIPELINES -->
              <!-- PIPELINES -->


              <div ng-if="overviewMode == 'pipelines'">
                <div id="pipelines" class="pipelines container-fluid" ng-repeat="(pipelineName, pipeline) in pipelines">
                  <p>Pipeline {{pipelineName}}</p>

                  <div ng-repeat="stage in pipeline.stages">
                    stage: {{stage.id}}
                  </div>
                </div>

        <!--         <pipelines-view
                  image-streams="imageStreams"
                  services="services"
                  deployment-configs-by-service="deploymentConfigsByService"
                  deployments-by-service-by-deployment-config="deploymentsByServiceByDeploymentConfig">
                </pipelines-view>
         -->

                <div id="pipelines" class="pipelines container-fluid" ng-repeat="(serviceId, service) in services">
                  <div class="row row-cards-pf">
                    <div ng-repeat="(deploymentConfigId, deployments) in deploymentsByServiceByDeploymentConfig[serviceId]">
                      <div ng-repeat="deployment in deployments | orderObjectsByDate : true track by (deployment | uid)" ng-if="isVisibleDeployment(deployment)">

                        <div ng-repeat="container in deployment.spec.template.spec.containers">
                          <div ng-if="imagesByDockerReference && container.image && (image = imagesByDockerReference[container.image])">
                            <div ng-if="build = (image | buildForImage : builds)" ng-init="buildConfigName = (build | label : 'openshift.io/build-config.name')">
                              <div class="pipeline-stage col-xs-3" ng-init="buildConfig = buildConfigs[buildConfigName]">
                                <div class="row">
                                  <div class="pipeline-stage-grouped col-xs-12">
                                    <div class="pipeline-stage-body completed">
                                      <div class="pipeline-stage-header">
                                        <label>
                                          <span class="pficon pficon-image" aria-hidden="true"></span>
                                          Image
                                        </label>
                                        <a href="#">{{buildConfig.spec.strategy.sourceStrategy.from.name.split(':')[0]}}</a>
                                      </div>
                                      <div class="pipeline-stage-content">
                                        <div style="font-size:80%;overflow:hidden;text-overflow:ellipsis;">
                                          <i>{{buildConfig.spec.strategy.sourceStrategy.from.name.split(':')[1]}}</i>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="connector">&rarr;</div>
                                  </div>
                                </div>
                                <div class="row">
                                  <div class="pipeline-stage-grouped col-xs-12">
                                    <div class="pipeline-stage-body completed">
                                      <div class="pipeline-stage-header">
                                        <label>
                                          <span class="pficon pficon-image" aria-hidden="true"></span>
                                          Source
                                        </label>
                                      </div>
                                      <div class="pipeline-stage-content">
                                        <div style="font-size:80%;overflow:hidden;text-overflow:ellipsis;">
                                          <code>{{buildConfig.spec.source.git.uri}}</code>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="connector">&rarr;</div>
                                  </div>
                                </div>
                              </div>

                              <div class="pipeline-stage col-xs-3">
                                <div class="pipeline-stage-body" ng-class="{completed: build.status.phase === 'Complete'}">
                                  <div class="pipeline-stage-header">
                                    <label>
                                      <span class="fa fa-refresh" aria-hidden="true"></span>
                                      Build
                                    </label>
                                    <a href="#">{{buildConfig.metadata.name}}</a>, <a href="#">#{{build | annotation : 'openshift.io/build.number'}}</a>
                                  </div>
                                  <div class="pipeline-stage-content">
                                  </div>
                                </div>
                                <div class="connector">&rarr;</div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div ng-repeat="(deploymentConfigId, deploymentConfig) in deploymentConfigsByService[serviceId]">
                          <div ng-if="deploymentConfig.spec.strategy.type === 'Recreate'">
                            <div class="pipeline-stage col-xs-3">
                              <div class="pipeline-stage-body completed">
                                <div class="pipeline-stage-header">
                                  <label>
                                    <span class="pficon pficon-image" aria-hidden="true"></span>
                                    Image
                                  </label>
                                  <a href="#">{{deploymentConfig.spec.template.spec.containers[0].image.split('/').slice(-1).pop().split(':')[0].split('@')[0]}}</a>
                                </div>
                                <div class="pipeline-stage-content">
                                  <div style="font-size:80%;overflow:hidden;text-overflow:ellipsis;">
                                    <i>{{deploymentConfig.spec.template.spec.containers[0].image | imageName}}</i>
                                  </div>
                                </div>
                              </div>
                              <div class="connector">&rarr;</div>
                            </div>
                          </div>
                          <div class="pipeline-stage col-xs-3">
                            <div class="pipeline-stage-body" ng-class="{completed: (deployment | deploymentStatus) === 'Deployed'}">
                              <div class="pipeline-stage-header">
                                <label>
                                  <span class="pficon pficon-deployment" aria-hidden="true"></span>
                                  Deployment
                                </label>
                                <a href="#">{{deploymentConfig.metadata.name}}</a>, <a href="#">#{{deployment | annotation:'deploymentVersion'}}</a>
                              </div>
                              <div class="pipeline-stage-content">
                                <div style="font-size:80%;overflow:hidden;text-overflow:ellipsis;">
                                  <i>{{deploymentConfig.spec.triggers[0].imageChangeParams.from.name || deploymentConfig.spec.template.spec.containers[0].image}}</i>
                                </div>
                              </div>
                            </div>
                            <div class="connector">&rarr;</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="pipeline-stage col-xs-3">
                      <div class="pipeline-stage-body completed">
                        <div class="pipeline-stage-header">
                          <label>
                            <span class="pficon pficon-service" aria-hidden="true"></span>
                            Service
                          </label>
                          <a href="#">{{service.metadata.name}}</a>
                        </div>
                        <div class="pipeline-stage-content">
                          <div style="font-size:80%;overflow:hidden;text-overflow:ellipsis;">
                            <i>{{service.spec.portalIP}}:{{service.spec.ports[0].port}}&rarr;{{service.spec.ports[0].targetPort}}</i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div><!-- /row -->
                </div><!-- /container -->

                <script src="bower_components/patternfly/components/matchHeight/jquery.matchHeight-min.js"></script>

                {{matchElementsHeight()}}

                <h2>Debug</h2>

                <div ng-init="debug = {}" ng-repeat="(serviceId, service) in services">
                  <h3 ng-click="debug[service.metadata.uid] = !debug[service.metadata.uid]">Service {{service.metadata.name}}</h3>
                  <pre ng-show="debug[service.metadata.uid]">
{{service | json}}</pre>
                  <div ng-repeat="(deploymentConfigId, deploymentConfig) in deploymentConfigsByService[serviceId]">
                    <h4 ng-click="debug[deploymentConfig.metadata.uid] = !debug[deploymentConfig.metadata.uid]">Deployment config {{deploymentConfig.metadata.name}}</h4>
                    <pre ng-show="debug[deploymentConfig.metadata.uid]">
{{deploymentConfig | json}}</pre>
                    <div ng-repeat="(deploymentConfigId, deployments) in deploymentsByServiceByDeploymentConfig[serviceId]">
                      <div ng-repeat="deployment in deployments | orderObjectsByDate : true track by (deployment | uid)">
                        <h5 ng-click="debug[deployment.metadata.uid] = !debug[deployment.metadata.uid]">Deployment {{deployment.metadata.name}}</h5>
                        <pre ng-show="debug[deployment.metadata.uid]">
{{deployment | json}}</pre>
                      </div>
                    </div>
                  </div>
                </div>

                <div ng-repeat="(buildConfigName, builds) in buildsByBuildConfig" ng-init="buildConfig = buildConfigs[buildConfigName]">
                  <h3 ng-click="debug[buildConfig.metadata.uid] = !debug[buildConfig.metadata.uid]">Build config {{buildConfigName}}</h3>
                  <pre ng-show="debug[buildConfig.metadata.uid]">
{{buildConfig | json}}</pre>
                  <div ng-repeat="(buildId, build) in builds | orderObjectsByDate : true track by (build | uid)">
                    <h4 ng-click="debug[build.metadata.uid] = !debug[build.metadata.uid]">Build {{build.metadata.name}}</h4>

                    <pre ng-show="debug[build.metadata.uid]">
{{build | json}}</pre>
                  </div>
                </div>
              </div>

              <div ng-repeat="(imageStreamName, imageStream) in imageStreams">
                <h3 ng-click="debug[imageStream.metadata.uid] = !debug[imageStream.metadata.uid]">Image stream {{imageStreamName}}</h3>
                <pre ng-show="debug[imageStream.metadata.uid]">
{{imageStream | json}}</pre>
              </div>

              <!-- /PIPELINES -->
              <!-- /PIPELINES -->
              <!-- /PIPELINES -->

            </div><!-- /col-* -->
          </div>
        </div>
      </div><!-- /middle-content -->
    </div><!-- /middle-container -->
  </div><!-- /middle-section -->
</project-page>
