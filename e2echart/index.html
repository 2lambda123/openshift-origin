<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>e2e-chart</title>
    <script src="//unpkg.com/timelines-chart"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>
<div id="chart"></div>

<div class="modal" id="myModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resource</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre><code id="myModalContent"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var loc = window.location.href;
    var eventIntervals = fetch('http://localhost:8080/e2e-interval.json')
        .then(response => response.json())
        .then(eventIntervals => {
            const el = document.querySelector('#chart');

            var timelineGroups = []
            timelineGroups.push({group: "a-operator-unavailable", data: []})
            createTimelineData("OperatorUnavailable", timelineGroups[timelineGroups.length-1].data, eventIntervals, isOperatorAvailable)

            timelineGroups.push({group: "a-operator-degraded", data: []})
            createTimelineData("OperatorDegraded", timelineGroups[timelineGroups.length-1].data, eventIntervals, isOperatorDegraded)

            timelineGroups.push({group: "a-operator-progressing", data: []})
            createTimelineData("OperatorProgressing", timelineGroups[timelineGroups.length-1].data, eventIntervals, isOperatorProgressing)

            timelineGroups.push({group: "e2e-test-failed", data: []})
            createTimelineData("Failed", timelineGroups[timelineGroups.length-1].data, eventIntervals, isE2EFailed)

            timelineGroups.push({group: "e2e-test-flaked", data: []})
            createTimelineData("Flaked", timelineGroups[timelineGroups.length-1].data, eventIntervals, isE2EFlaked)

            timelineGroups.push({group: "e2e-test-passed", data: []})
            createTimelineData("Passed", timelineGroups[timelineGroups.length-1].data, eventIntervals, isE2EPassed)

            var segmentFunc = function (segment) {
                // for (var i in data) {
                //     if (data[i].group == segment.group) {
                //         var groupdata = data[i].data
                //         for (var j in groupdata) {
                //             if (groupdata[j].label == segment.label) {
                //                 labeldata = groupdata[j].data
                //                 for (var k in labeldata) {
                //                     var startDate = new Date(labeldata[k].timeRange[0])
                //                     var endDate = new Date(labeldata[k].timeRange[1])
                //                     if (startDate.getTime() == segment.timeRange[0].getTime() &&
                //                         endDate.getTime() == segment.timeRange[1].getTime()) {
                //                         $('#myModalContent').text(labeldata[k].extended)
                //                         $('#myModal').modal()
                //                     }
                //                 }
                //             }
                //         }
                //     }
                // }
            }
            const myChart = TimelinesChart();
            var ordinalScale = d3.scaleOrdinal()
                .domain(['OperatorUnavailable', 'OperatorDegraded', 'OperatorProgressing', 'Passed', 'Skipped', 'Flaked', 'Failed', 'Degraded', 'Upgradeable', 'False', 'Unknown'])
                .range([ '#d0312d',             '#d0312d',          '#ffa500',             '#3cb043','#ceba76', '#ffa500','#d0312d', '#b65049', '#32b8b6', '#ffffff', '#bbbbbb']);
            myChart.data(timelineGroups).zQualitative(true).enableAnimations(false).leftMargin(320).rightMargin(550).maxLineHeight(20).maxHeight(10000).zColorScale(ordinalScale).onSegmentClick(segmentFunc)
            (el);
        });

    function isOperatorAvailable(eventInterval) {
        if (eventInterval.locator.startsWith("clusteroperator/") && eventInterval.message.includes("condition/Available") && eventInterval.message.includes("status/False")) {
            console.log(eventInterval.message)
            return true
        }
        return false
    }

    function isOperatorDegraded(eventInterval) {
        if (eventInterval.locator.startsWith("clusteroperator/") && eventInterval.message.includes("condition/Degraded") && eventInterval.message.includes("status/True")) {
            return true
        }
        return false
    }

    function isOperatorProgressing(eventInterval) {
        if (eventInterval.locator.startsWith("clusteroperator/") && eventInterval.message.includes("condition/Progressing") && eventInterval.message.includes("status/True")) {
            return true
        }
        return false
    }

    function isE2EFailed(eventInterval) {
        if (eventInterval.locator.startsWith("e2e-test/") && eventInterval.message.includes("finished As \"Failed")) {
            return true
        }
        return false
    }

    function isE2EFlaked(eventInterval) {
        if (eventInterval.locator.startsWith("e2e-test/") && eventInterval.message.includes("finished As \"Flaked")) {
            return true
        }
        return false
    }

    function isE2EPassed(eventInterval) {
        if (eventInterval.locator.startsWith("e2e-test/") && eventInterval.message.includes("finished As \"Passed")) {
            return true
        }
        return false
    }

    function createTimelineData(timelineVal, timelineData, rawEventIntervals, preconditionFunc) {
        for (var i in rawEventIntervals.items) {
            if (!preconditionFunc(rawEventIntervals.items[i])) {
                continue
            }
            var startDate = new Date(rawEventIntervals.items[i].from)
            var endDate = new Date(rawEventIntervals.items[i].to)
            timelineData.push(
                {
                    label: rawEventIntervals.items[i].locator,
                    data: [
                        {
                            timeRange: [startDate, endDate],
                            val: timelineVal
                        }
                    ]
                }
            )
        }
    }

</script>
</body>
</html>
